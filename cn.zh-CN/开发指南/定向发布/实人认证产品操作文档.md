# 实人认证产品操作文档 {#concept_pvj_ljl_sfb .concept}

## 产品简介 {#section_p4x_ljl_sfb .section}

实人认证是一种身份验证服务，通过采集用户的面部特征并与权威数据源进行比对，判断用户是否为本人和真人。

-   **权威数据源**：权威认证的数据源，覆盖率接近 100%。
-   **判断是否为本人**：判断用户是否是身份证持有者本人。
-   **判断是否为真人**：内置多种活体检测算法，判断面部特征是否来自真实的自然人，能够抵挡照片、视频等多种攻击手段。

实人认证能够判断当前用户是否是真实证件的持有者本人，帮您实现实人认证、降低业务经营风险、提高客户管理能力，有效防止身份冒用、欺诈等风险。

## 产品特色 {#section_lmc_qjl_sfb .section}

-   **权威数据源**：采用权威认证的数据源做比对，覆盖率接近100%。
-   **高准确性**：金融级精准度，真实场景中的误识率低于十万分之一。
-   **高安全性**：全球独有眼纹专利和领先活体检测技术，能有效拦截照片、视频、3D软件模拟及面具攻击。
-   **海量业务验证**：经实践验证，成熟可靠，服务超过2亿互联网金融用户，保障超20亿次交易安全。
-   **极致体验**：全球首创非配合式活体检测，无需用户做任何动作，无需注册采集，秒级验证通过。
-   **高稳定性**：基于蚂蚁金融云高可用、动态扩展的服务框架体系。

## 接入指南 {#section_ifb_5jl_sfb .section}

**一、调用方式**

**1，接口基本信息**

服务请求地址：https://saf.cn-shanghai.aliyuncs.com

协议：HTTPS

方式：POST

**2，签名机制**

关于创建AccessKey的方法，请参考[创建AccessKey](https://help.aliyun.com/document_detail/66453.html)。

关于签名方式的介绍，请参考[RPC API签名](https://help.aliyun.com/document_detail/66384.html)。

**二、请求参数**

**1，公共参数**

服务接口的入参参数包含**公共请求参数**和**具体服务事件参数**。公共请求参数是指每一个接口都需要使用到的参数，具体见下表。

|名称|类型|是否必需|描述|
|--|--|----|--|
|Format|String|是|返回值的类型，支持JSON与XML，默认为XML。|
|Version|String|是|API版本号，为日期形式：YYYY-MM-DD，本版本对应为2017-03-31。|
|AccessKeyId|String|是|阿里云颁发给用户的访问服务所用的密钥ID。|
|Signature|String|是|签名结果串，关于签名的计算方法，请参考签名机制。|
|SignatureMethod|String|是|签名方式，目前支持HMAC-SHA1。|
|Timestamp|String|是|请求的时间戳。日期格式按照ISO8601标准表示，并需要使用UTC时间。格式为：YYYY-MM-DDThh:mm:ssZ。例如，2014-7-29T12:00:00Z（为北京时间2014年7月29日的20点0分0秒）。

|
|SignatureVersion|String|是|签名算法版本，目前版本是1.0。|
|SignatureNonce|String|是|唯一随机数，用于防止网络重放攻击。用户在不同请求间要使用不同的随机数值。|
|Action|String|是|要执行的操作。取值：ExecuteRequest。|
|Service|String|是|具体服务名。取值：face\_verify。|
|ServiceParameters|String|是|具体服务参数的json格式串，具体定义见下面各接口参数定义。|

**2、统一返回Code的说明**

|Code|Message|
|----|-------|
|200|请求正常。|
|400|ServiceParameters（服务参数）不合法。|
|402|日QPS超过已购规格，限流。|
|403|权限不足，服务未开通或已到期。|
|404|Service（服务参数）不合法。|
|500|内部服务器错误。|

**说明：** 文档中的返回code做了合并处理，事实上各个环节都有明确的返回码解析，可以暴露出来便于结果查询，也可以统一封装成以上统一code。暂时按照统一封装code返回，减少用户接入成本。

**三、实人认证时序图**

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/60898/154208767230638_zh-CN.png)

1.  接入方客户端调用人脸认证 SDK 相关接口获取 metainfo。
2.  人脸认证 SDK 将metainfo 返回给接入方客户端。
3.  接入方客户端将 metainfo 上传给接入方服务端。
4.  接入方服务端访问人脸认证服务端做认证初始化。
5.  人脸认证初始化完成，刷脸认证服务端将相关数据返回给接入方服务端。
6.  接入方服务端将 queryId 返回给接入方客户端。
7.  接入方客户端调用刷脸认证 SDK，开始认证。
8.  刷脸认证 SDK 结束认证。
9.  接入方客户端通知接入方服务端去获取认证结果。
10. 接入方服务端访问刷脸认证服务端查询认证结果。
11. 刷脸认证服务端将认证结果和采集的人脸照片返回给接入方服务端。
12. 接入方服务端处理认证结果，并通过接入方客户端向用户展示结果。

**四、人脸认证初始化**

**1，请求参数**

ServiceParameters的json字符串里应包含以下字段：

|名称|类型|是否必需|描述|
|--|--|----|--|
|method|String|是|取值：init|
|certNumber|String|是|用户身份证件号。|
|name|String|是|用户姓名。|
|bizId|String|是|接入方请求的唯一标识，由字母、数字、下划线组成，商户须确保其唯一性。建议：开头使用一段自定义商户简称，中间使用一段日期，末尾使用一个序列。

示例：ZSTP2018013076546767654695203625

|
|metainfo|String|是|metainfo 环境参数，需要通过客户端 SDK 获取（详见刷脸认证 iOS 和 Android 客户端接入指南）示例：\{ “appName”:… \}

|

**2，响应参数**

|名称|类型|描述|示例|
|--|--|--|--|
|queryId|String|刷脸认证唯一标识。如果初始化失败则为空，可通过返回码分析具体原因。|731be7f204a962b0486a9b64ea3050ae|

-   调用成功的响应示例

    ```
    percentEncode（CanonicalizedQueryString）
    
    {
    "Data": {
        "queryId":"用来重新是否认证成功的字符串",
        "bizId":"查询的时候会需要"
    },
    "Message": "OK",
    "Code": 200, //200表示请求成功
    "RequestId":"4EF9AEE5-288F-4176-8110-00EDC91A614E"
    
    }
    ```

-   调用失败的响应示例

    ```
    {
    "Message": "服务器内部错误",
    "Code": 500,
    "RequestId":"4EF9AEE5-288F-4176-8110-00EDC91A614E"
    
    }
    ```

    或者

    ```
    {
    "Message": "name不能为空",
    "Code": 400,
    "RequestId":"4EF9AEE5-288F-4176-8110-00EDC91A614E"
    
    }
    ```


返回码说明见统一返回码所述。

**说明：** 如客户选择该环节详细返回码透出，则明细返回码见下表。

|resultCode（返回码）|resultCodeSub（明细返回码）|resultMsgSub（明细返回码对应的文案）|说明|
|---------------|--------------------|------------------------|--|
|OK|Z8100|初始化成功（Z8100）|初始化成功|
|INVALID\_PARAMETER|Z8101|抱歉，系统出错了，请您稍后再试（Z8101）|初始化时传入参数不正确|
|INVALID\_PARAMETER|Z8105|用户身份信息无效，请填写正确的身份信息（Z8105）|请求参数中的用户身份信息无效，请填写正确的身份信息|
|PRODUCT\_NOT\_OPEN|Z8102|请去开通产品（Z8102）|当前租户未开通刷脸认证产品|
|SYSTEM\_ERROR|Z8199|抱歉，系统出错了，请稍后再试（Z8199）|初始化时发生系统错误|
|DEVICE\_NOT\_SUPPORT|Z1108|当前设备不支持刷脸（Z1108））|设备类型不支持|
|SDKVERSION\_NOT\_SUPPORT|Z1110|应用版本过低（Z1110）|SDK版本不支持|
|OS\_NOT\_SUPPORT|Z1109|当前系统不支持刷脸（Z1109）|系统版本不支持|
|UNABLE\_GET\_IMAGE|Z1102|抱歉，您暂时无法使用刷脸服务（Z1102）|比对源不可用|
|SYSTEM\_ERROR|Z1111|抱歉，系统出错了，请您稍后再试（Z1111）|初始化策略结果获取失败|
|SYSTEM\_ERROR|Z1112|抱歉，系统出错了，请您稍后再试（Z1112）|暂时无法使用刷脸认证|
|SYSTEM\_ERROR|Z1199|抱歉，系统出错了，请您稍后再试（Z1199）|暂时无法使用刷脸认证|
|INVALID\_PARAMETER|Z5101|抱歉，系统出错了，请您稍后再试（Z5101）|暂时无法使用刷脸认证|
|INVALID\_PARAMETER|Z5102|抱歉，系统出错了，请您稍后再试（Z5102）|初始化时发生系统错误|
|INVALID\_PARAMETER|Z5103|抱歉，系统出错了，请您稍后再试（Z5103）|初始化时发生系统错误|
|SYSTEM\_ERROR|Z5199|抱歉，系统出错了，请您稍后再试（Z5199）|初始化时发生系统错误|
|HIGH\_RISK|Z1114|抱歉，系统出错了，请您稍后再试（Z1114）|刷脸失败次数过多，请您稍后再试|

**五、人脸结果查询**

**1，请求参数**

ServiceParameters的json字符串里应包含以下字段：

|名称|类型|描述|示例值|
|--|--|--|---|
|method|String|查询人脸比对结果，取值：query|query|
|bizId|String|接入方请求的唯一标识，与认证初始化接口传入的bizId保持一致。|ZSTP2018013076546767654695203625|
|queryId|String|刷脸认证唯一标识，来自init接口的结果。|731be7f204a962b0486a9b64ea3050ae|

**2，响应参数**

|名称|类型|描述|示例|
|--|--|--|--|
|queryId|String|刷脸认证唯一标识。如果初始化失败则为空，可通过返回码分析具体原因。|731be7f204a962b0486a9b64ea3050ae|

-   调用成功的响应示例

    ```
    {
        "Message":"OK",
        "Code":200,
        "RequestId":"4EF9AEE5-288F-4176-8110-00EDC91A614E"
    }
    ```

-   调用失败的响应示例

    ```
    {
        "Message":"不通过的原因",
        "Code":400,
        "RequestId":"4EF9AEE5-288F-4176-8110-00EDC91A614E"
    }
    ```

    或者

    ```
    {
        "Message":"服务器内部错误",
        "Code":500,
        "RequestId":"4EF9AEE5-288F-4176-8110-00EDC91A614E"
    }
    ```


返回码说明见统一返回码所述。

**说明：** 如果客户选择该环节详细返回码透出，则明细返回码见下表。

|resultCode（返回码）|resultCodeSub（明细返回码）|resultMsgSub（明细返回码对应的文案）|说明|
|---------------|--------------------|------------------------|--|
|OK|Z8300|认证成功（Z8300）|刷脸认证通过|
|INVALID\_PARAMETER|Z8301|抱歉，系统出错了，请您稍后再试（Z8301）|查询时传入参数不正确|
|NOT\_SAME\_PERSON|Z1146|抱歉，没有认出您（Z1146）|刷脸认证未通过|
|PRODUCT\_NOT\_OPEN|Z8302|请去开通产品（Z8302）|当前租户未开通刷脸认证产品|
|SYSTEM\_ERROR|Z8399|抱歉，系统出错了，请稍后再试（Z8399）|查询时发生系统错误|
|PROCESSING|Z5137|抱歉，系统出错了，请稍后再试（Z5137）|刷脸认证未完成|

**六、客户端文档**

实人认证提供客户端 SDK 帮助接入方在 App 中实现刷脸认证功能。接入方可通过刷脸认证服务端认证初始化接口获取刷脸认证唯一标识zimId，并使用zimId唤起刷脸认证客户端 SDK。下文将结合示例代码，进行详细的说明介绍。

**iOS接入**

您需要先下载 SDK（FaceDetectDemo-master-ios-3.0.zip \(11.79 MB\) ），再在客户端中添加 SDK 和相关系统库，然后拷贝资源文件。

**1，Framework列表**

-   APBToygerFacade.framework
-   ZolozMobileRPC.framework
-   APPSecuritySDK.framework
-   BioAuthAPI.framework
-   BioAuthEngine.framework
-   MPRemoteLogging.framework
-   ToygerService.framework
-   ZolozIdentityManager.framework
-   ZolozSensorServices.framework
-   ZolozOpenPlatformBuild.framework

如下图所示：

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/60898/154208767230845_zh-CN.png)

**2，添加刷脸认证 SDK**

在 Apple Xcode 中，选择**TARGETS**，单击**General**标签页， 展开**Linked Frameworks andLibraries**列表，添加在上一步中下载的SDK，如下图所示：

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/60898/154208767230846_zh-CN.png)

**3，添加系统库**

在LinkedFramweworks and Libraries中添加如下iOS系统库：

-   CoreGraphics.framework
-   Accelerate.framework
-   SystemConfiguration.framework
-   AssetsLibrary.framework
-   CoreTelephony.framework
-   QuartzCore.framework
-   CoreFoundation.framework
-   CoreLocation.framework
-   ImageIO.framework
-   CoreMedia.framework
-   CoreMotion.framework
-   AVFoundation.framework
-   libz.tbd
-   libc++.1.tbd
-   libstdc++.6.0.9.tbd
-   libc++abi.tbd

如下图所示：

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/60898/154208767230847_zh-CN.png)

**4，拷贝资源文件**

选择**TARGETS**，单击**Build Phases**标签页，在Copy Bundle Resources中添加如下三个bundle：

-   APBToygerFacade.bundle：在APBToygerFacade.framework 中。
-   ToygerService.bundle：在ToygerService.framework 中。
-   BioAuthEngine.bundle：在BioAuthEngine.framework 中。

如下图所示：

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/60898/154208767230848_zh-CN.png)

**5，链接器参数设置**

选择 **TARGETS**，单击 **Build Settings** 标签页，在 **Linking**中设置 **Other linker flags** 值为 -**ObjC**。

如下图所示：

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/60898/154208767230849_zh-CN.png)

**6，调用SDK**

1.  引入头文件。

    ```
    #import <ZolozIdentityManager/ZolozIdentityPublicApi.h>
    ```

2.  初始化SDK。

    ```
    [ZolozSdk init]
    ```

    增加初始化接口是为了提高身份核验的用户体验，为刷脸认证准备一些必备数据。初始化接口是异步执行，不会影响主线程 UI 渲染，建议接入方将初始化接口放在 appdelegate 的如下函数中调用：

    ```
    (BOOL)application:(UIApplication)applicationdidFinishLaunchingWithOptions:(NSDictionary)launchOptions
    ```

3.  获取 metainfo 数据。

    ```
    [ZolozIdentityManagergetMetaInfo]
    ```

    返回值是 NSDictionary，接入方服务端需要将其转换为 JSON 字符串，调用服务端人脸认证初始化 时在入参 metainfo中传入该值。

4.  开始认证。
    -   调用参数说明

        有两个参数，第一个是 zimId（通过服务端 人脸认证初始化 获取）；第二个是 extParams，具体参数为：

        |名称|类型|是否必需|描述|
        |--|--|----|--|
        |currentCtr|对象|是|当前页面的controller。|

    -   调用 SDK。

        ```
        [[ZolozIdentityManager sharedInstance] verifyWith:_zimID extParams:extParams onCompletion:^(ZIMResponse *response) {}];
        ```

    -   示例代码。

        ```
        [[ZolozIdentityManager sharedInstance] verifyWith:_queryId extParams:extParams onCompletion:^(ZIMResponse *response) {
                     NSString *title = @"刷脸成功";
                     switch (response.code) {
                         case 1000:
                             break;
                         case 1001:
                             title = @"系统错误";
                             break;
                         case 1003:
                             title = @"验证中断";
                             break;
                         case 2002:
                             title = @"网络错误";
                             break;
                         case 2006:
                             title = @"刷脸失败";
                             break;
                         default:
                             break;
                     }
        ```

    -   返回结果。

        ```
        [[ZolozIdentityManager sharedInstance] verifyWith:_zimID extParams:extParams onCompletion:^(ZIMResponse *response) {}];
        ```

        respons.code 有以下五种返回值，类型是整型：

        -   1000：代表刷脸成功，该结果仅供参考，可通过服务端人脸结果查询获取最终认证结果
        -   1001：表示系统错误
        -   1003：表示验证中断
        -   2002：表示网络错误
        -   2006：表示刷脸失败，如需获取更详细的失败原因，需调用服务端人脸结果查询接口

**Andriod接入**

实人认证提供 Android 客户端 SDK 帮助接入方在 App 中实现刷脸认证功能。接入方可通过实人认证服务端认证初始化接口获取刷脸认证唯一标识 zimId，并使用 zimId 唤起刷脸认证客户端 SDK。下文将结合示例代码进行详细的说明介绍。

您需要先下载 SDK（FaceDetectDemo-master-andriod-3.0.zip \(1.9 MB\) ），再在客户端中添加 SDK 和相关系统库，然后拷贝资源文件。

**1，调用SDK**

以下是定义接口的示例代码：

```
/**
 * 刷脸认证接口
 */
public abstract class ZIMFacade {
    /**
     * 预初始化接口，建议接入方在调用其它接口前，先调用此接口
     * 
     * @context Context
     */
    public static void install(Context context);
    /**
     * 获取环境参数接口
     * 
     * @context Context
     */
    public static String getMetaInfos(Context context);
    /**
     * identify interface for android
     * 需在 UI 线程上调用，不会阻塞调用线程
     *
     * @param queryId    刷脸认证唯一标识，请从刷脸认证服务端认证初始化接口获取
     * @param params   业务扩展参数    
     * @param callback 认证结果的回调接口
     */
    public abstract void verify(String queryId, Map<String, String> params, ZIMCallback callback);
}
```

**2，接口调用**

1.  初始化SDK。

    为提高身份核验的用户体验，并为刷脸认证准备必要数据，Android 客户端需要进行 SDK 初始化。初始化的代码示例如下：

    ```
    ZIMFacade.install(context);
    ```

2.  获取 metainfo 数据。

    ```
    String metaInfos = ZIMFacade.getMetaInfos(context);
    ```

    接入方服务端在调用刷脸认证服务端人脸认证初始化接口时需要传入该 metainfo值。

3.  开始认证。

    ```
    ZIMFacade zimFacade = ZIMFacadeBuilder.create(MainActivity.this);
    zimFacade.verify(zimId, null, new ZIMCallback() {
     @Override
     public boolean response(ZIMResponse response) {
         // TODO: 接入方在这里实现自身业务
         if (null != response && 1000 == response.code) {
             // 认证成功
         } else {
             // 认证失败
         }
         return true；
     }
    }
    ```

    **说明：** 

    -   第 2 行命令中的zimId是刷脸认证唯一标识，可从刷脸认证服务端 认证初始化接口 获取。
    -   ZIMCallback的 response 回调需要有返回值，默认为true。
4.  返回结果。

    刷脸认证SDK 回调结果中的 ZIMResponse类，该类中定义了对应的结果编码和原因，如下所示：

    ```
    /**
    * 刷脸认证回调结果
    */
    public class ZIMResponse {
     /**
      * 返回结果编码:
      * 1000: 刷脸成功
      * 1001: 系统错误
      * 1003: 验证中断
      * 2002: 网络错误
      * 2006: 刷脸失败
      */
     public int code;
     /**
      * 返回结果原因信息
      */
     public String reason;
    }
    ```

    返回结果说明：

    -   1000：代表刷脸成功，该结果仅供参考，可通过服务端人脸结果查询接口接口 获取最终认证结果
    -   1001：表示系统错误
    -   1003：表示验证中断
    -   2002：表示网络错误
    -   2006：表示刷脸失败，如需获取更详细的失败原因，需调用服务端人脸结果查询接口接口

**七、demo示例代码**

最小化代码：

```
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.SimpleTimeZone;
import java.util.UUID;

import org.apache.commons.io.FileUtils;

import com.google.common.io.BaseEncoding;

public class PopTestV2 {
    public static void main(String[] args) throws Throwable {
        saf_pop_test();
    }

    public static void saf_pop_test() throws Throwable {
        //阿里云账号的 appKey 和 appSecret
        String appKey = "*****";
        String appSecret = "*****";
        String safUrl = "https://saf.cn-shanghai.aliyuncs.com";

        Map<String, String> serviceParameters = tools.MapUtil.create();
        //method value:init,query,match
        serviceParameters.put("method", "init");
        serviceParameters.put("caller", "15888827666");
        serviceParameters.put("name", "duanxf");
        serviceParameters.put("certNumber", "15888827666");

        /*method = query
        serviceParameters.put("method", "query");
        serviceParameters.put("bizid", "15888827666");
        serviceParameters.put("queryId", "15888827666");
        //method = match
        serviceParameters.put("method", "match");
        serviceParameters.put("certNumber", "******");
        serviceParameters.put("imgbase64", "*****");
        */

        // ---------------继续追加其他参数，不同的service，需要的参数也会不同
        // serviceParameters.put...
        saf(appKey, appSecret, safUrl, "2017-03-31", "face_verify", serviceParameters);
    }

    public static String doPOPRequest(String appKey, String appSecret, String url, String action, String v,
                                      Map<String, String> parameters)
            throws Throwable {
        // 本来依赖fastjson和http client包
        // 阿里云账号的AK，需替换成你们自己的线上账号AK。
        // https://help.aliyun.com/document_detail/66453.html?spm=a2c4g.11186623.6.547.PovY4k
        String encoding = "UTF-8";
        Map<String, String> paramsForPOP = new HashMap<>();

        // 公共参数-固定
        paramsForPOP.put("AccessKeyId", appKey);
        paramsForPOP.put("Format", "JSON");// 固定
        paramsForPOP.put("SignatureMethod", "HMAC-SHA1");// 固定
        paramsForPOP.put("Timestamp", formatIso8601Date(new Date()));// 注意格式是：YYYY-MM-DDThh:mm:ssZ
        paramsForPOP.put("SignatureVersion", "1.0");// 固定
        paramsForPOP.put("SignatureNonce", UUID.randomUUID().toString());// 自行生成一个随机串，每次请求不可重复
        paramsForPOP.put("Version", v);// 固定
        paramsForPOP.put("Action", action);// 固定 -->"ExecuteRequest"

        if (parameters != null) {
            parameters.remove("Signature");
            paramsForPOP.putAll(parameters);
        }

        // 得到签名 https://www.alibabacloud.com/help/zh/doc-detail/27572.htm?spm=a3c0i.o27570zh.b99.80.7c7ad9cd6jC8dM
        // https://help.aliyun.com/document_detail/66384.html?spm=a2c4g.11186623.6.543.wIP2rf
        String signature = computeSignature(paramsForPOP, appSecret, encoding);
        paramsForPOP.put("Signature", signature);// 把签名附加到post参数里

        // 发送请求，可以替换为自己的http request lib
        String result = tools.http.HttpRequestBuilder.create(url).data(paramsForPOP).readTimeout(8500).charset(encoding)
                .post().toString();

        // --->>> {"Data":{"score":56.0},"Message":"OK","Code":200}

        System.out.println(result);
        return result;
    }

    public static String saf(String appKey, String appSecret, String url, String v, String service,
                             Map<String, String> serviceParameters)
            throws Throwable {

        Map<String, String> params = new HashMap<>();

        // 接口业务参数-固定
        params.put("Service", service);// 服务code，必填，由阿里云颁发，不可随意，account_abuse=垃圾账户识别；coupon_abuse=活动作弊 ...

        // 附加上业务详细参数，服务详细参数，具体见文档里的业务参数部分，业务参数整体转换为json格式
        params.put("ServiceParameters", com.alibaba.fastjson.JSON.toJSONString(serviceParameters));

        return doPOPRequest(appKey, appSecret, url, "ExecuteRequest", v, params);
    }

    private static String formatIso8601Date(Date date) {
        SimpleDateFormat df = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'");
        df.setTimeZone(new SimpleTimeZone(0, "GMT"));// 注意使用GMT时间
        return df.format(date);
    }

    public static String computeSignature(Map<String, String> parameters, String secret, String encoding)
            throws Exception {
        // 将参数Key按字典顺序排序
        String[] sortedKeys = parameters.keySet().toArray(new String[] {});
        Arrays.sort(sortedKeys);

        String separator = "&";
        boolean first = true;

        // 生成规范化请求字符串
        StringBuilder sb = new StringBuilder();
        for (String key : sortedKeys) {
            if (first) {
                first = false;
            } else {
                sb.append("&");
            }

            sb.append(encode(key, encoding)).append("=").append(encode(parameters.get(key), encoding));
        }

        // 生成用于计算签名的字符串 toSign
        StringBuilder toSign = new StringBuilder();
        toSign.append("POST").append(separator);
        toSign.append(encode("/", encoding)).append(separator);
        toSign.append(encode(sb.toString(), encoding));

        // System.out.println("===> " + toSign.toString());

        // 注意点：在secret后面要加入一个字符"&"
        return getSignature("HmacSHA1", (secret + separator).getBytes(encoding), toSign.toString().getBytes(encoding));
    }

    private static String encode(String value, String encoding) throws UnsupportedEncodingException {
        if (value == null)
            return null;

        // 使用URLEncoder.encode编码后，将"+","*","%7E"做替换即满足 API规定的编码规范
        return URLEncoder.encode(value, encoding).replace("+", "%20").replace("*", "%2A").replace("%7E", "~");
    }

    public static String getSignature(String algorithm, byte[] secret, byte[] data) {
        // return tools.Convert.getSignature(algorithm, secret, data);
        try {
            // String algorithm = "HmacSHA384";//HmacSHA256";
            javax.crypto.Mac mac = javax.crypto.Mac.getInstance(algorithm);
            mac.init(new javax.crypto.spec.SecretKeySpec(secret, algorithm));

            return BaseEncoding.base64().encode(mac.doFinal(data));
        } catch (Exception e) {// InvalidKeyException NoSuchAlgorithmException
            e.printStackTrace();
        }

        return null;
    }
}
```

**八、人脸认证接入操作文档**

请求参数ServiceParameters的json字符串里应包含以下字段：

|名称|类型|是否必需|描述|
|--|--|----|--|
|method|String|是|取值：match|
|name|String|是|用户姓名。|
|certNumber|String|是|用户身份证件号。|
|imgbase64|String|是|人脸图片二进制数据base64编码。|

返回码说明见文档前面所述。

